services:
  # Component Generator Service
  component-generator:
    build:
      context: ./component-generator
    container_name: flowise-component-generator
    ports:
      - "8085:8085"
    environment:
      - PORT=8085
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-20250514}
      - COMPONENT_RAG_URL=${COMPONENT_RAG_URL:-http://component-index:8086}
      - CORS_ORIGINS=${CORS_ORIGINS:-["http://localhost:8086", "http://localhost:3000"]}
    volumes:
      - component_data:/app/data
    networks:
      - flowise-network
    depends_on:
      component-index:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/api/flowise/component-generator/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Component Index Service (includes RAG pattern search)
  component-index:
    build:
      context: ./component-index
    container_name: flowise-component-index
    ports:
      - "8086:8086"
    environment:
      - PORT=8086
      - STORAGE_PATH=/app/data/components
      - FLOWISE_COMPONENTS_DIR=/app/data/flowise_components
      - CHROMADB_DIR=/app/data/chromadb
      - CORS_ORIGINS=${CORS_ORIGINS:-["http://localhost:8085", "http://localhost:3000"]}
    volumes:
      - index_data:/app/data
      - ./component-index/data/flowise_components:/app/data/flowise_components:ro
    networks:
      - flowise-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/api/flowise/component-index/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

networks:
  flowise-network:
    driver: bridge

volumes:
  component_data:
  index_data:
